<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Ethical Choice Simulator - Firebase Pro</title>
    <style>
        :root {
            --rail-color: #888;
            --sleeper-color: #4a302a;
            --gravel-color: #222;
            --primary-orange: #d35400;
            --bg-color: #1a1a1a;
        }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg-color); color: white; margin: 0; display: flex; flex-direction: column; align-items: center; padding-top: 40px; }

        /* ë©”ì¸ í™ˆ í™”ë©´ */
        #home-screen { width: 850px; text-align: center; }
        .admin-bar { display: flex; justify-content: flex-end; margin-bottom: 10px; }
        .name-box { background: #333; padding: 25px; border-radius: 12px; margin-bottom: 30px; border: 1px solid #555; }
        .stage-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .stage-card { background: #252525; padding: 30px 15px; border-radius: 15px; cursor: pointer; border: 2px solid #444; transition: 0.3s; }
        .stage-card:hover:not(.stage-locked) { border-color: var(--primary-orange); transform: translateY(-5px); box-shadow: 0 5px 15px rgba(211, 84, 0, 0.3); }
        .stage-locked { opacity: 0.3; cursor: not-allowed; filter: grayscale(1); }
        .stage-cleared { border-color: #27ae60 !important; position: relative; }
        .stage-cleared::before { content: "âœ“"; position: absolute; top: 10px; right: 10px; color: #27ae60; font-weight: bold; }

        /* ê²Œì„ í”Œë ˆì´ í™”ë©´ */
        #game-play { display: none; width: 900px; text-align: center; background: #2d2d2d; padding: 25px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.7); }
        .stage-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #stage-area { position: relative; height: 380px; background: var(--gravel-color); margin: 20px 0; border-radius: 12px; overflow: hidden; border: 5px solid #333; }
        .rail-track { position: absolute; height: 50px; background-image: linear-gradient(0deg, transparent 20%, var(--rail-color) 20%, var(--rail-color) 26%, transparent 26%, transparent 74%, var(--rail-color) 74%, var(--rail-color) 80%, transparent 80%), linear-gradient(90deg, var(--sleeper-color) 12px, transparent 12px); background-size: 100% 100%, 35px 100%; z-index: 3; }
        .main-line { width: 100%; top: 80px; left: 0; }
        .bottom-line { width: 100%; top: 250px; left: 0; }
        .connector-diagonal { position: absolute; width: 320px; height: 50px; top: 165px; left: 100px; transform: rotate(31deg); z-index: 2; background-image: linear-gradient(0deg, transparent 20%, var(--rail-color) 20%, var(--rail-color) 26%, transparent 26%, transparent 74%, var(--rail-color) 74%, var(--rail-color) 80%, transparent 80%), linear-gradient(90deg, var(--sleeper-color) 12px, transparent 12px); background-size: 100% 100%, 35px 100%; }
        #trolley { position: absolute; left: -100px; top: 75px; font-size: 60px; z-index: 10; }
        .victim-group { position: absolute; right: 100px; z-index: 5; transition: 0.5s; text-align: right; }
        .status-icon { position: absolute; font-size: 25px; top: -30px; left: 50%; transform: translateX(-50%); opacity: 0; }

        /* ëª¨ë‹¬ ë° í…Œì´ë¸” */
        #log-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center; }
        .log-window { background: #222; width: 95%; max-width: 850px; max-height: 85vh; border-radius: 20px; border: 1px solid var(--primary-orange); display: flex; flex-direction: column; overflow: hidden; }
        .log-header { background: #333; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .log-tabs { display: flex; background: #2a2a2a; padding: 10px 20px; gap: 10px; border-bottom: 1px solid #444; overflow-x: auto; }
        .tab-btn { background: #444; border: none; color: #ccc; padding: 8px 15px; border-radius: 5px; cursor: pointer; white-space: nowrap; position: relative; }
        .tab-btn.active { background: var(--primary-orange); color: white; }
        .log-body { padding: 20px; overflow-y: auto; flex-grow: 1; color: #ddd; }
        .log-table { width: 100%; border-collapse: collapse; text-align: left; font-size: 14px; }
        .log-table th { background: #2d2d2d; color: var(--primary-orange); padding: 12px; border-bottom: 2px solid #444; }
        .log-table td { padding: 12px; border-bottom: 1px solid #333; }
        .status-v { color: #2ecc71; font-weight: bold; }
        .status-x { color: #e74c3c; font-weight: bold; }

        /* ë¹„ìœ¨ ê·¸ë˜í”„ ìŠ¤íƒ€ì¼ */
        .stat-container { margin: 20px 0; background: #222; padding: 15px; border-radius: 12px; border: 1px solid #444; }
        .stat-row { margin-bottom: 15px; text-align: left; }
        .stat-label { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 5px; }
        .stat-bar-bg { background: #444; height: 12px; border-radius: 6px; overflow: hidden; }
        .stat-bar-fill { height: 100%; width: 0%; transition: width 1s ease-out; }
        .fill-stay { background: #7f8c8d; } /* ë°©ê´€ - íšŒìƒ‰ */
        .fill-switch { background: var(--primary-orange); } /* ë ˆë²„ - ì˜¤ë Œì§€ */

        #final-report { display: none; width: 850px; background: #222; padding: 30px; border-radius: 20px; border: 1px solid #27ae60; }
        .report-item { background: #333; padding: 15px; margin: 10px 0; border-radius: 10px; border-left: 5px solid var(--primary-orange); }
        .btn { padding: 10px 20px; cursor: pointer; border: none; border-radius: 8px; color: white; font-weight: bold; }
        .btn-orange { background: var(--primary-orange); }
        .btn-gray { background: #555; }
        .is-hit { filter: grayscale(1); transform: scale(0.8); opacity: 0.5; }
        #next-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #333; padding: 30px; border-radius: 20px; border: 1px solid var(--primary-orange); z-index: 200; text-align: center; }

        @keyframes drive-straight { 0% { left: 20px; } 100% { left: 110%; } }
        @keyframes drive-side { 0% { left: 20px; top: 75px; transform: rotate(0deg); } 20% { left: 110px; top: 75px; transform: rotate(31deg); } 75% { left: 450px; top: 245px; transform: rotate(0deg); } 100% { left: 110%; top: 245px; } }
    </style>
</head>
<body>

    <div id="home-screen">
        <div class="admin-bar"><button class="btn btn-gray" id="btn-open-log" style="font-size:12px;">ğŸ“Š ê´€ë¦¬ì ë¡œê·¸</button></div>
        <h1>ìœ¤ë¦¬ì  ì„ íƒ ì‹œë®¬ë ˆì´í„°</h1>
        <div class="name-box">
            <label style="font-weight: bold; font-size: 1.1em;">ì°¸ì—¬ì ì„±í•¨: </label>
            <input type="text" id="global-name" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="10" 
                   style="padding: 12px; border-radius: 8px; border: 2px solid var(--primary-orange); width: 220px; background: #111; color: white; font-size: 1em;">
            <p style="font-size: 12px; color: #888; margin-top: 10px;">* ë§ˆì§€ë§‰ ì…ë ¥ëœ ì´ë¦„ì„ ê¸°ì–µí•©ë‹ˆë‹¤. ìŠ¤í…Œì´ì§€ í´ë¦­ ì‹œ ì €ì¥ì´ ì‹œì‘ë©ë‹ˆë‹¤.</p>
        </div>
        <div class="stage-grid">
            <div class="stage-card" id="card-1-1"><h3>Stage 1-1</h3><p>ìˆ˜ëŸ‰ì˜ ë”œë ˆë§ˆ</p></div>
            <div class="stage-card stage-locked" id="card-1-2"><h3>Stage 1-2</h3><p>ë¯¸ë˜ì˜ ë”œë ˆë§ˆ</p></div>
            <div class="stage-card stage-locked" id="card-1-3"><h3>Stage 1-3</h3><p>ê°€ì¹˜ì˜ ë”œë ˆë§ˆ</p></div>
        </div>
    </div>

    <div id="game-play">
        <div class="stage-header">
            <button class="btn btn-gray btn-go-home">â—€ ìŠ¤í…Œì´ì§€ ëª©ë¡</button>
            <h2 id="stage-title">Stage 1-1</h2>
            <div style="width:100px;"></div>
        </div>
        <div id="stage-area">
            <div class="rail-track main-line"></div><div class="connector-diagonal"></div><div class="rail-track bottom-line"></div><div id="trolley">ğŸšƒ</div>
            <div id="victims-top" class="victim-group" style="top: 75px;"><span id="label-top" style="display:block; font-size:12px; color:#ff9f43; font-weight:bold;"></span><span class="status-icon"></span><span id="icons-top" style="font-size:40px;"></span></div>
            <div id="victims-bottom" class="victim-group" style="top: 245px;"><span id="label-bottom" style="display:block; font-size:12px; color:#ff9f43; font-weight:bold;"></span><span class="status-icon"></span><span id="icons-bottom" style="font-size:40px;"></span></div>
        </div>
        <div id="choice-buttons">
            <button class="btn btn-gray" id="btn-stay">ê°€ë§Œíˆ ë‘ê¸°</button>
            <button class="btn btn-orange" id="btn-switch">ë ˆë²„ ë‹¹ê¸°ê¸°</button>
        </div>
    </div>

    <div id="final-report">
        <h2 style="color:#27ae60;">ğŸ ìµœì¢… ì„ íƒ ë³´ê³ ì„œ</h2>
        <p id="final-user-info" style="font-size: 1.2em; font-weight: bold; border-bottom: 1px solid #444; padding-bottom: 10px;"></p>
        <div id="report-list"></div>
        <button class="btn btn-orange btn-go-home" style="margin-top:20px;">ìŠ¤í…Œì´ì§€ ëª©ë¡ìœ¼ë¡œ</button>
    </div>
    
    <div id="next-modal">
    <h3 id="modal-msg">ê²°ì • ì™„ë£Œ</h3>
    
    <div class="stat-container">
        <p style="font-size: 13px; color: #aaa; margin-top: 0;">ì‹¤ì‹œê°„ ì„ íƒ ë¹„ìœ¨</p>
        <div class="stat-row">
            <div class="stat-label"><span>ê°€ë§Œíˆ ë‘ê¸° (ë°©ê´€)</span><span id="pct-stay">0%</span></div>
            <div class="stat-bar-bg"><div id="bar-stay" class="stat-bar-fill fill-stay"></div></div>
        </div>
        <div class="stat-row" style="margin-bottom:0;">
            <div class="stat-label"><span>ë ˆë²„ ë‹¹ê¸°ê¸°</span><span id="pct-switch">0%</span></div>
            <div class="stat-bar-bg"><div id="bar-switch" class="stat-bar-fill fill-switch"></div></div>
        </div>
    </div>

    <div style="display:flex; gap:10px; justify-content:center;">
        <button class="btn btn-gray btn-go-home">ëª©ë¡ìœ¼ë¡œ</button>
        <button id="modal-next-btn" class="btn btn-orange">ë‹¤ìŒ ë‹¨ê³„ë¡œ â–¶</button>
    </div>
</div>

    <div id="log-modal">
        <div class="log-window">
            <div class="log-header">
                <h3 style="margin:0; color:var(--primary-orange);">ğŸ“Š ì„ íƒ ë¡œê·¸ (ì¤‘ì•™ ì„œë²„)</h3>
                <div>
                    <button class="btn btn-gray" id="btn-reset-data" style="background:#c0392b; margin-right:10px; font-size:12px;">âš ï¸ ì´ˆê¸°í™”</button>
                    <button class="btn btn-gray" id="btn-close-log">ë‹«ê¸°</button>
                </div>
            </div>
            <div class="log-tabs" id="log-tabs-area">
                <button class="tab-btn active" data-sid="1-1">Stage 1-1</button>
                <button class="tab-btn" data-sid="1-2">Stage 1-2</button>
                <button class="tab-btn" data-sid="1-3">Stage 1-3</button>
                <button class="tab-btn" id="tab-summary" style="border:1px solid #27ae60;">ğŸ† ìµœì¢…ê²°ê³¼ ìš”ì•½</button>
            </div>
            <div class="log-body">
                <div id="summary-legend" style="display:none;">ğŸ’¡ <b>V</b>: ë ˆë²„ ë‹¹ê¹€ | <b>X</b>: ë°©ê´€ | ğŸ–±ï¸ ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ì •ë³´</div>
                <table class="log-table"><thead id="log-table-head"></thead><tbody id="log-table-body"></tbody></table>
            </div>
        </div>
    </div>

   <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-analytics.js";
import { getDatabase, ref, set, push, update, onValue, remove, get } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyCjd9E70iIuFSTZt19KnpYG54yPwYvyD2I",
    authDomain: "trolley-dilema.firebaseapp.com",
    databaseURL: "https://trolley-dilema-default-rtdb.firebaseio.com",
    projectId: "trolley-dilema",
    storageBucket: "trolley-dilema.firebasestorage.app",
    messagingSenderId: "423289380510",
    appId: "1:423289380510:web:fe5d7c39edf85cab7f658f",
    measurementId: "G-38BSRBRLCF"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const db = getDatabase(app);

let userStats = {};
let currentStage = "";
let isEnded = false;
let currentUserName = localStorage.getItem('trolley_user_name') || "";

const stageData = {
    '1-1': { title: "Stage 1-1", info: "ì¼ë°˜ì¸ 5ëª… vs 1ëª…", top: "ì¼ë°˜ì¸ 5ëª…", bottom: "ì¼ë°˜ì¸ 1ëª…", iT: "ğŸ§ğŸ§ğŸ§ğŸ§ğŸ§", iB: "ğŸ§", next: "1-2", topCount: 5, bottomCount: 1 },
    '1-2': { title: "Stage 1-2", info: "ë…¸ì¸ 5ëª… vs ì–´ë¦°ì´ 1ëª…", top: "ë…¸ì¸ 5ëª…", bottom: "ì–´ë¦°ì´ 1ëª…", iT: "ğŸ‘´ğŸ‘´ğŸ‘´ğŸ‘´ğŸ‘´", iB: "ğŸ‘¶", next: "1-3", topCount: 5, bottomCount: 1 },
    '1-3': { title: "Stage 1-3", info: "ë…¸ìˆ™ì 5ëª… vs ì˜ì‚¬ 1ëª…", top: "ë…¸ìˆ™ì 5ëª…", bottom: "ì˜ì‚¬ 1ëª…", iT: "ğŸ‘¤ğŸ‘¤ğŸ‘¤ğŸ‘¤ğŸ‘¤", iB: "ğŸ©º", next: "done", topCount: 5, bottomCount: 1 }
};

// ì´ˆê¸° ì‹¤í–‰: ì´ë¦„ ë¡œë“œ
if(currentUserName) {
    document.getElementById('global-name').value = currentUserName;
    loadUserData(currentUserName);
}

// ì´ë¦„ ì…ë ¥ ì‹œ ì¦‰ì‹œ ë°ì´í„° ë¡œë“œ ë° UI ì—…ë°ì´íŠ¸
document.getElementById('global-name').addEventListener('input', (e) => {
    const newName = e.target.value.trim();
    currentUserName = newName;
    localStorage.setItem('trolley_user_name', newName);
    if (newName) loadUserData(newName);
    else updateStageVisuals({});
});

function loadUserData(name) {
    onValue(ref(db, 'userStats/' + name), (snapshot) => {
        const data = snapshot.val() || { unlocked: ['1-1'], choices: {} };
        userStats[name] = data;
        updateStageVisuals(data);
    });
}

function updateStageVisuals(userData) {
    const unlocked = userData.unlocked || ['1-1'];
    const choices = userData.choices || {};
    ['1-1', '1-2', '1-3'].forEach(sid => {
        const card = document.getElementById(`card-${sid}`);
        if (!card) return;
        card.classList.remove('stage-locked', 'stage-cleared');
        if (!unlocked.includes(sid)) card.classList.add('stage-locked');
        else if (choices[sid]) card.classList.add('stage-cleared');
    });
}

const checkAndStart = (sid) => {
    if (!currentUserName) { alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!"); return; }
    const userData = userStats[currentUserName] || { unlocked: ['1-1'] };
    if (!userData.unlocked.includes(sid)) { alert("ì´ì „ ë‹¨ê³„ë¥¼ ì™„ë£Œí•˜ì„¸ìš”."); return; }
    startStage(sid);
};

const startStage = (sid) => {
    currentStage = sid; isEnded = false;
    const data = stageData[sid];
    document.getElementById('home-screen').style.display = 'none';
    document.getElementById('game-play').style.display = 'block';
    document.getElementById('final-report').style.display = 'none';
    document.getElementById('next-modal').style.display = 'none';
    document.getElementById('stage-title').innerText = data.title;
    document.getElementById('label-top').innerText = data.top;
    document.getElementById('label-bottom').innerText = data.bottom;
    document.getElementById('icons-top').innerText = data.iT;
    document.getElementById('icons-bottom').innerText = data.iB;
    const t = document.getElementById('trolley');
    t.style.animation = "none"; t.style.left = '-100px'; t.style.top = '75px';
    document.querySelectorAll('.victim-group').forEach(g => { 
        g.classList.remove('is-hit'); g.querySelector('.status-icon').style.opacity = 0; 
    });
};

/* ======================================= */
/* ğŸ”§ ìˆ˜ì •: ê²°ì • ë¡œì§ ë° ì‹¤ì‹œê°„ ë¹„ìœ¨ ê·¸ë˜í”„ ì¶”ê°€ */
/* ======================================= */
const decide = async (mode) => {
    if (isEnded) return; isEnded = true;
    const data = stageData[currentStage];
    const victim = (mode === 'switch') ? {t: data.bottom, c: data.bottomCount, a: "ë ˆë²„ ë‹¹ê¹€", code: "V"} : {t: data.top, c: data.topCount, a: "ë°©ê´€", code: "X"};
    
    // ë°ì´í„° ì €ì¥
    const updates = {};
    updates[`userStats/${currentUserName}/choices/${currentStage}`] = victim;
    const currentUnlocked = userStats[currentUserName]?.unlocked || ['1-1'];
    if (data.next !== 'done' && !currentUnlocked.includes(data.next)) {
        currentUnlocked.push(data.next);
        updates[`userStats/${currentUserName}/unlocked`] = currentUnlocked;
    }
    await update(ref(db), updates);

    // ì• ë‹ˆë©”ì´ì…˜
    const t = document.getElementById('trolley');
    if (mode === 'switch') {
        t.style.animation = "drive-side 2.8s forwards ease-in-out";
        setTimeout(() => showHit('victims-bottom'), 2200);
    } else {
        t.style.animation = "drive-straight 2.5s forwards linear";
        setTimeout(() => showHit('victims-top'), 1600);
    }
    
    // ë¡œê·¸ ì „ì†¡
    await push(ref(db, `logs/stage_${currentStage}`), {
        name: currentUserName, choice: victim.a, victimName: victim.t, date: new Date().toLocaleTimeString()
    });

    // ì‹¤ì‹œê°„ ë¹„ìœ¨ ê³„ì‚°
    const snap = await get(ref(db, `logs/stage_${currentStage}`));
    const allLogs = snap.val() || {};
    const logArray = Object.values(allLogs);
    const totalCount = logArray.length;
    const switchCount = logArray.filter(l => l.choice === "ë ˆë²„ ë‹¹ê¹€").length;
    const switchPct = Math.round((switchCount / totalCount) * 100);
    const stayPct = 100 - switchPct;

    setTimeout(() => {
        // ê·¸ë˜í”„ UI ì—…ë°ì´íŠ¸
        document.getElementById('pct-stay').innerText = `${stayPct}%`;
        document.getElementById('pct-switch').innerText = `${switchPct}%`;
        document.getElementById('bar-stay').style.width = `${stayPct}%`;
        document.getElementById('bar-switch').style.width = `${switchPct}%`;

        document.getElementById('next-modal').style.display = 'block';
        const nBtn = document.getElementById('modal-next-btn');
        if (data.next !== 'done') {
            nBtn.innerText = "ë‹¤ìŒ ë‹¨ê³„ë¡œ â–¶";
            nBtn.onclick = () => startStage(data.next);
        } else {
            nBtn.innerText = "ìµœì¢… ê²°ê³¼ ë³´ê¸° ğŸ";
            nBtn.onclick = showFinalReport;
        }
    }, 3000);
};

const showHit = (id) => {
    const h = document.getElementById(id);
    h.classList.add('is-hit');
    h.querySelector('.status-icon').innerText = "ğŸ’€";
    h.querySelector('.status-icon').style.opacity = 1;
};

/* ============================= */
/* ğŸ”§ ìˆ˜ì • 1 : Final Report ì•ˆì •í™” */
/* ============================= */
const showFinalReport = () => {
    document.getElementById('game-play').style.display = 'none';
    document.getElementById('next-modal').style.display = 'none';
    document.getElementById('final-report').style.display = 'block';
    document.getElementById('final-user-info').innerText = `[${currentUserName}] ë‹˜ì˜ ê²°ê³¼`;

    let html = "";
    let total = 0;
    const choices = userStats[currentUserName]?.choices || {};

    ['1-1', '1-2', '1-3'].forEach(sid => {
        const c = choices[sid];
        if (c && typeof c.c === 'number') {
            total += c.c;
            html += `<div class="report-item"><b>${sid}</b>: ${c.a} <span style="color:#ff4d4d;">(ğŸ’€ ${c.t} í¬ìƒ)</span></div>`;
        }
    });

    const totalDisplay = total > 0 ? total + 'ëª…' : '0ëª…';
    html += `<div style="background:#111; padding:20px; border-radius:10px; margin-top:15px; border: 1px solid #27ae60; text-align:center;">
        ì´ í¬ìƒì: <b style="color:#ff4d4d;">${totalDisplay}</b>
    </div>`;
    document.getElementById('report-list').innerHTML = html;
};

/* ============================= */
/* ğŸ”§ ìˆ˜ì • 2 : Summary ì•ˆì •í™” */
/* ============================= */
const showSummary = () => {
    document.getElementById('summary-legend').style.display = 'block';
    document.getElementById('log-table-head').innerHTML = `<tr><th>ì°¸ì—¬ì</th><th>1-1</th><th>1-2</th><th>1-3</th><th>ì´ í¬ìƒ</th></tr>`;
    const tbody = document.getElementById('log-table-body');
    tbody.innerHTML = "ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

    get(ref(db, 'userStats')).then(snap => {
        const allData = snap.val() || {};
        tbody.innerHTML = "";
        Object.keys(allData).reverse().forEach(name => {
            const u = allData[name];
            let total = 0;
            const cells = ['1-1', '1-2', '1-3'].map(sid => {
                const c = u.choices ? u.choices[sid] : null;
                if (c && typeof c.c === 'number') {
                    total += c.c;
                    return `<td><span class="${c.code==='V'?'status-v':'status-x'}">${c.code}</span></td>`;
                }
                return `<td>-</td>`;
            });
            const totalDisplay = total > 0 ? total + 'ëª…' : '0ëª…';
            tbody.innerHTML += `<tr><td>${name}</td>${cells.join('')}<td style="color:#ff4d4d;">${totalDisplay}</td></tr>`;
        });
    });
};

const filterLog = (sid) => {
    document.getElementById('summary-legend').style.display = 'none';
    document.getElementById('log-table-head').innerHTML = `<tr><th>ì´ë¦„</th><th>ê²°ì •</th><th>í¬ìƒì</th><th>ì‹œê°„</th></tr>`;
    const tbody = document.getElementById('log-table-body');
    tbody.innerHTML = "ë¡œë“œ ì¤‘...";
    get(ref(db, `logs/stage_${sid}`)).then(snap => {
        tbody.innerHTML = "";
        const val = snap.val();
        if (val) Object.values(val).reverse().forEach(l => {
            tbody.innerHTML += `<tr><td>${l.name}</td><td>${l.choice}</td><td style="color:#ff4d4d;">ğŸ’€ ${l.victimName}</td><td>${l.date}</td></tr>`;
        });
    });
};

// ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
document.getElementById('card-1-1').onclick = () => checkAndStart('1-1');
document.getElementById('card-1-2').onclick = () => checkAndStart('1-2');
document.getElementById('card-1-3').onclick = () => checkAndStart('1-3');
document.getElementById('btn-stay').onclick = () => decide('stay');
document.getElementById('btn-switch').onclick = () => decide('switch');
document.querySelectorAll('.btn-go-home').forEach(b => b.onclick = () => {
    document.getElementById('game-play').style.display = 'none';
    document.getElementById('final-report').style.display = 'none';
    document.getElementById('next-modal').style.display = 'none';
    document.getElementById('home-screen').style.display = 'block';
});
document.getElementById('btn-open-log').onclick = () => {
    if (prompt("ì•”í˜¸: 1234") === "1234") {
        document.getElementById('log-modal').style.display = 'flex';
        filterLog('1-1');
    }
};
document.getElementById('btn-close-log').onclick = () => document.getElementById('log-modal').style.display = 'none';
document.getElementById('btn-reset-data').onclick = () => {
    if (confirm("ì„œë²„ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) remove(ref(db, '/')).then(() => location.reload());
};
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.onclick = (e) => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        if (e.target.id === 'tab-summary') showSummary();
        else filterLog(e.target.dataset.sid);
    };
});
</script>
</body>
</html>